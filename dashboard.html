<div class="row">
  <div class="col-12">
    <!--BEGIN TITLE-->
    <h1>Dashboard</h1>
    <!--END TITLE-->
    <h3>Riassunto carriera
      <?echo $_SESSION["fullname"];?>...
    </h3>
    <br>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
      <!--BEGIN CARD-->
      <div class="col">
        <div class="card shadow-sm h-100">
          <div>
            <div class="card-body table-responsive">
              <h4 class="card-title">Materie del giorno</h4>
              <table class="table table-striped table-hover " id="table">
                <thead>
                  <tr>
                    <th scope="col">Materia</th>
                    <th scope="col">Orario</th>
                    <th scope="col">Aula</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Programmazione Web</td>
                    <td>09:00 - 11:00</td>
                    <td>Lab. T-3</td>
                  </tr>
                  <tr>
                    <td>Sicurezza dei Sistemi</td>
                    <td>11:00 - 13:00</td>
                    <td>Lab. A-T-1</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!--END CARD-->

      <!--BEGIN CARD-->
      <div class="col">
        <div class="card shadow-sm h-100">
          <div>
            <canvas id="average"></canvas>
          </div>
          <div>
            <div class="card-body">
              <h4 class="card-title mt-3">Media voti</h4>
              <p class="card-text" id="averageLabel">
                Aggiungi voti per visualizzare la media
              </p>
              <div class="d-flex justify-content-between align-items-center">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--END CARD-->

      <!--BEGIN CARD-->
      <div class="col">
        <div class="card shadow-sm h-100">
          <img src="https://quickchart.io/chart?c={type:'progressBar',data:{datasets:[{data:[50]}]}}">
          <div>
            <div class="card-body">
              <h4 class="card-title">Tasse</h4>
              <p class="card-text" id="taxes">
                Aggiungi tasse per visualizzare il saldo
              </p>
              <div class="d-flex justify-content-between align-items-center">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--END CARD-->
      <!--BEGIN CARD-->
      <div class="col">
        <div class="card shadow-sm h-100">
          <img class="mt-3" id="cfuGraph"
            src="#">
          <div>
            <div class="card-body">
              <h4 class="card-title">CFU</h4>

              <p class="card-text" id="cfuLeft">Mancanti: 84</p>
              <br>
              <div class="d-flex justify-content-between align-items-center">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--END CARD-->

      <!--BEGIN CARD-->
      <div class="col">
        <div class="card shadow-sm h-100">
          <canvas id="marksQuantity"></canvas>
          <div>
            <div class="card-body">
              <h4 class="card-title">Grafico voti</h4>
              <p id="mostCommonMarkLabel"></p>
              <div class="d-flex justify-content-between align-items-center">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--END CARD-->

      <!--BEGIN CARD-->
      <div class="col">
        <div class="card shadow-sm h-100">
          <img class="mt-3" id="expectedDegreeMark"
            src="#">
          <div>
            <div class="card-body">
              <h4 class="card-title">Base Voto Di Laurea</h4>

              <p class="card-text" id="expectedDegreeMarkLabel">Previsto: 103.5</p>
              <br>
              <div class="d-flex justify-content-between align-items-center">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--END CARD-->
    </div>
    <br>
  </div>
</div>
<script>



  function convertDate(date) {
        var date_new = new Date(date);
        return new Intl.DateTimeFormat('it-IT').format(date_new);
  }

  function buildChart(elem, type, labels, data, data2) {
    const myChart = new Chart(elem, {
      type: type,
      data: {
        labels: labels,
        datasets: [{
          label: 'Aritmetica',
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
          ],
          borderWidth: 1
        },
        {
          label: 'Ponderata',
          data: data2,
          backgroundColor: [
            'rgba(54, 162, 235, 0.2)',
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    return myChart;
  }

  function buildPieChart(elem, type,labels, data) {
    const myChart = new Chart(elem, {
      type: type,
      data: {
        labels: labels,

        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(251,248,204, 0.7)',
            'rgba(253,228,207, 0.7)',
            'rgba(255,207,210, 0.7)',
            'rgba(241,192,232, 0.7)',
            'rgba(207,186,240, 0.7)',
            'rgba(163,196,243, 0.7)',
            'rgba(144,219,244, 0.7)',
            'rgba(142,236,245, 0.7)',
            'rgba(152,245,225, 0.7)',
            'rgba(185,251,192, 0.7)',
          ],
          borderColor: [
            'rgba(251,248,204, 1)',
            'rgba(253,228,207, 1)',
            'rgba(255,207,210, 1)',
            'rgba(241,192,232, 1)',
            'rgba(207,186,240, 1)',
            'rgba(163,196,243, 1)',
            'rgba(144,219,244, 1)',
            'rgba(142,236,245, 1)',
            'rgba(152,245,225, 1)',
            'rgba(185,251,192, 1)',
          ],
          borderWidth: 2
        }]
      }
    });
  }

  $("document").ready(function () {
    $.ajax({
      url: "php/stats.php",
      type: "POST",
      data: {
        action: "cfu"
      },
      success: function (data) {
        var json = JSON.parse(data);
        if (!json.error) {

          var missingCfu = parseInt(json.total_credits) - parseInt(json.cfu);
          $("#cfuLeft").html("Mancanti: " + (missingCfu || "180"));
          var url = "https://quickchart.io/chart?c={type:'radialGauge',data:{datasets:[{data:[" + parseInt(json.cfu) + "]}]}, options: {domain: [0," + parseInt(json.total_credits) + "]}}";
          $("#cfuGraph").attr("src", url);

        }
      }
    });

    const average = document.getElementById('average').getContext('2d');
    const averageElement = document.getElementById('marksQuantity').getContext('2d');
    $.ajax({
      url: "php/stats.php",
      type: "POST",
      data: {
        action: "averages"
      },
      success: function (data) {
        var json = JSON.parse(data);
        if (!json.error && json.exams != null) {
          var sumAverage = 0;
          var sumMean = 0
          var sumCfu = 0
          var dates = []
          var marks = [];
          var quantities = [];
          var averages = []
          var mean = []
          var markFrequencies = {}; 
          var maxValue = "";

          
          for (var i = 0; i < json.exams.length; i++) {
            dates.push(String(convertDate(json.exams[i].exam_date)));
            sumAverage += parseInt(json.exams[i].mark);
            sumMean += (parseInt(json.exams[i].mark) * parseInt(json.exams[i].cfu));
            sumCfu += parseInt(json.exams[i].cfu);
            averages.push((parseInt(sumAverage) / parseInt(i+1)).toFixed(2));
            mean.push((parseInt(sumMean) / parseInt(sumCfu)).toFixed(2));

            var currentMark = json.exams[i].mark > 30 ? "30L" : json.exams[i].mark;

            if (currentMark in markFrequencies) {
              markFrequencies[currentMark] += 1;
            } else {
              markFrequencies[currentMark] = 1;
            }
          }

          for (var key in markFrequencies) {
            quantities.push(markFrequencies[key]);
            marks.push(key);

            if (maxValue == "" || markFrequencies[key] > markFrequencies[maxValue]) {
              maxValue = key;
            }
          }


          let indexHighest = marks.indexOf(Math.max(...marks));
          $("#mostCommonMarkLabel").html("Voto pi√π frequente: " + maxValue);
          $("#averageLabel").html("Media aritmetica: " + averages[json.exams.length - 1] + "<br> Media ponderata: " + mean[json.exams.length - 1]);

          var expectedDegreeMark =  ((mean[json.exams.length - 1]*11)/3).toFixed(2);
          var url = "https://quickchart.io/chart?c={type:'radialGauge',data:{datasets:[{data:["+ expectedDegreeMark+"]}]}, options: {domain: [0,110], animation: {animateRotate: true}, centerArea: {text: "+ expectedDegreeMark+"}}}";

          var firstChart = buildChart(average, "line", dates, averages, mean);
          $("#expectedDegreeMark").attr("src", url);
          $("#expectedDegreeMarkLabel").html("Previsto: " + expectedDegreeMark);
          buildPieChart(averageElement, "pie", marks, quantities)

        } else {
          console.log(json.error)
          var url = "https://quickchart.io/chart?c={type:'radialGauge',data:{datasets:[{data:["+ 0 +"]}]}, options: {domain: [0,110], animation: {animateRotate: true}, centerArea: {text: "+ 0 +"}}}";
          $("#expectedDegreeMark").attr("src", url);
          $("#expectedDegreeMarkLabel").html("Previsto: 0");

        }
      }
    })


  });


</script>